# Sets a QoS rule (test_qos_routes_rule)

SET (test_qos_routes_rule, "test_qos_routes_m00 < 10") INTO QOS;200
EXPORT FROM QOS WHERE name == test_qos_routes_rule;200;/qos/test_qos_routes_rule

################################################################################
# Sets actions for QoS (test_qos_action_01, test_qos_action_02, test_qos_action_03)
################################################################################

# The test_qos_action_01 returns a true normally to propagate the related route (test_qos_route_02)
SET ("test_qos_action_01","python","aW1wb3J0IGZvcmVtYW4KZGVmIHRlc3RfcW9zX2FjdGlvbl8wMShwYXJhbXMscmVzdWx0cyk6CiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBwYXJhbXMuaXRlcml0ZW1zKCk6CiAgICAgICAgY2hrS2V5ID0gJ3Fvc19hY3Rpb25fMDFfJXMnICUga2V5CiAgICAgICAgZm9yZW1hbi5zZXRfcmVnaXN0ZXIoY2hrS2V5LCBzdHIodmFsdWUpKQogICAgICAgICMgUGFzcyBhbGwgUW9TIHBhcmFtZXRlcnMgdG8gdGVzdF9xb3NfYWN0aW9uXzAyCiAgICAgICAgcmVzdWx0c1trZXldID0gdmFsdWUKICAgIHJldHVybiBUcnVlCg==","base64") INTO ACTION;200;
EXPORT FROM ACTION WHERE name == "test_qos_action_01";200;/action/methods/test_qos_action_01
EXECUTE test_qos_action_01;200;

# The test_qos_action_02 returns a false not to propagate the related route (test_qos_route_03)
SET ("test_qos_action_02","python","aW1wb3J0IGZvcmVtYW4KZGVmIHRlc3RfcW9zX2FjdGlvbl8wMihwYXJhbXMscmVzdWx0cyk6CiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBwYXJhbXMuaXRlcml0ZW1zKCk6CiAgICAgICAgY2hrS2V5ID0gJ3Fvc19hY3Rpb25fMDJfJXMnICUga2V5CiAgICAgICAgZm9yZW1hbi5zZXRfcmVnaXN0ZXIoY2hrS2V5LCBzdHIodmFsdWUpKQogICAgIyBSZXR1cm5zIGEgZmFsc2Ugbm90IHRvIHJ1biB0aGUgcmVsYXRlZCByb3V0ZXMKICAgIHJldHVybiBGYWxzZQ==","base64") INTO ACTION;200;
EXPORT FROM ACTION WHERE name == "test_qos_action_02";200;/action/methods/test_qos_action_02
EXECUTE test_qos_action_02;400;

# The test_qos_action_03 is registered, but it is not executed because the source action (test_qos_action_02) in the related route (test_qos_route_03) returns a false
SET ("test_qos_action_03","python","aW1wb3J0IGZvcmVtYW4KIyBUaGUgYWN0aW9uICh0ZXN0X3Fvc19hY3Rpb25fMDMpIGlzIG5vdCBleGVjdXRlZCBiZWNhdXNlIHRoZSBkZXN0aW5hdGlvbiBhY3Rpb24gKHRlc3RfcW9zX2FjdGlvbl8wMikgcmV0dXJucyBhIGZhbHNlCmRlZiB0ZXN0X3Fvc19hY3Rpb25fMDMocGFyYW1zLHJlc3VsdHMpOgogICAgZm9yIGtleSwgdmFsdWUgaW4gcGFyYW1zLml0ZXJpdGVtcygpOgogICAgICAgIGNoa0tleSA9ICdxb3NfYWN0aW9uXzAzXyVzJyAlIGtleQogICAgICAgIGZvcmVtYW4uc2V0X3JlZ2lzdGVyKGNoa0tleSwgc3RyKHZhbHVlKSkKICAgIHJldHVybiBUcnVl","base64") INTO ACTION;200;
EXPORT FROM ACTION WHERE name == "test_qos_action_03";200;/action/methods/test_qos_action_03
EXECUTE test_qos_action_03;200;

################################################################################
# Sets routes for the QoS rule and actions
# test_qos_routes_rule -> test_qos_action_02
# test_qos_action_01 -> test_qos_action_02
################################################################################

SET (test_qos_route_01, test_qos_routes_rule, test_qos_action_01) INTO ROUTE;200
SET (test_qos_route_02, test_qos_action_01, test_qos_action_02) INTO ROUTE;200
SET (test_qos_route_03, test_qos_action_02, test_qos_action_03) INTO ROUTE;200
EXPORT FROM ROUTE WHERE name == "test_qos_route_01";200;/action/routes/test_qos_route_01
EXPORT FROM ROUTE WHERE name == "test_qos_route_02";200;/action/routes/test_qos_route_02
EXPORT FROM ROUTE WHERE name == "test_qos_route_03";200;/action/routes/test_qos_route_03

################################################################################
# Inserts a satisfied metric
################################################################################

SET (test_qos_routes_m00, 1.0, 1514764800) INTO METRICS;200
EXPORT FROM REGISTER WHERE name == test_qos_routes_m00;200;/register/test_qos_routes_m00/value;1.0

################################################################################
# Inserts a unsatisfied metric to execute the related route actions
################################################################################

SET (test_qos_routes_m00, 20.0, 1514764800) INTO METRICS;200
EXPORT FROM REGISTER WHERE name == test_qos_routes_m00;200;/register/test_qos_routes_m00/value;20.0

# Examines the execution result of 'test_qos_action_01' from the register
# Register : qos_action_01_(test_qos_routes_m00)
EXPORT FROM REGISTER WHERE name == qos_action_01_test_qos_routes_m00;200;/register/qos_action_01_test_qos_routes_m00/value;20.0

# Examines the execution result of 'test_qos_action_02' from the register
# Register : qos_action_02_(test_qos_routes_m00)
EXPORT FROM REGISTER WHERE name == qos_action_02_test_qos_routes_m00;200;/register/qos_action_02_test_qos_routes_m00/value;20.0

# Examines whether 'test_qos_action_03' is not executed by the register
# Register : qos_action_03_(test_qos_routes_m00)
EXPORT FROM REGISTER WHERE name == qos_action_03_test_qos_routes_m00;400;