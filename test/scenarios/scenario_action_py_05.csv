################################################################################
# Sets a source route rule for QoS
# qos_rs999
################################################################################

SET (qos_rs999, "qos_m0_p999 < 100") INTO QOS;200
EXPORT FROM QOS WHERE name == qos_rs999;200;/qos/qos_rs999

################################################################################
# Sets destination actions for QoS 
# test_qos_analyze_correlation
# test_qos_export_metrics
################################################################################

SET ("test_qos_analyze_correlation","python","aW1wb3J0IGRhdGV0aW1lCmltcG9ydCB0aW1lCmltcG9ydCBqc29uCmltcG9ydCBmb3JlbWFuCgpkZWYgdGVzdF9xb3NfYW5hbHl6ZV9jb3JyZWxhdGlvbihwYXJhbXMscmVzdWx0cyk6CiAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICBub3dUcyA9IGludCh0aW1lLm1rdGltZShub3cudGltZXR1cGxlKCkpKQogIGZyb21UcyA9IG5vd1RzIC0gKDYwICogNjApCiAgdW50aWxUcyA9IG5vd1RzCiAgZm9yIGtleSwgdmFsdWUgaW4gcGFyYW1zLml0ZXJpdGVtcygpOgogICAgcSA9ICdBTkFMWVpFICVzIEZST00gTUVUUklDUyBXSEVSRSB0cyA+PSAlZCBBTkQgdHMgPD0gJWQnICUgKGtleSwgZnJvbVRzLCB1bnRpbFRzKQogICAgcmVzdWx0c1sncSddID0gcQogICAganNvblJlcyA9IGZvcmVtYW4uZXhlY3V0ZV9xdWVyeShxKQogICAgaWYganNvblJlcyBpcyBOb25lOgogICAgICByZXR1cm4gVHJ1ZQogIHJldHVybiBUcnVlCg==","base64") INTO ACTION;200
EXPORT FROM ACTION WHERE name == "test_qos_analyze_correlation";200;/action/methods/test_qos_analyze_correlation

SET ("test_qos_export_metrics","python","aW1wb3J0IGRhdGV0aW1lCmltcG9ydCB0aW1lCmltcG9ydCBqc29uCmltcG9ydCBmb3JlbWFuCgpkZWYgdGVzdF9xb3NfZXhwb3J0X21ldHJpY3MocGFyYW1zLHJlc3VsdHMpOgogIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgbm93VHMgPSBpbnQodGltZS5ta3RpbWUobm93LnRpbWV0dXBsZSgpKSkKICBmcm9tVHMgPSBub3dUcyAtICg0ICogNjApCiAgdW50aWxUcyA9IG5vd1RzCiAgZm9yIGtleSwgdmFsdWUgaW4gcGFyYW1zLml0ZXJpdGVtcygpOgogICAgcSA9ICdFWFBPUlQgRlJPTSBNRVRSSUNTIFdIRVJFIHRzID49ICVkIEFORCB0cyA8PSAlZCcgJSAoZnJvbVRzLCB1bnRpbFRzKQogICAgcmVzdWx0c1sncSddID0gcQogICAganNvblJlcyA9IGZvcmVtYW4uZXhlY3V0ZV9xdWVyeShxKQogICAgaWYganNvblJlcyBpcyBOb25lOgogICAgICByZXR1cm4gRmFsc2UKICByZXR1cm4gVHJ1ZQo=","base64") INTO ACTION;200
EXPORT FROM ACTION WHERE name == "test_qos_export_metrics";200;/action/methods/test_qos_export_metrics

################################################################################
# Sets routes for the QoS rule
# qos_rs999 -> test_qos_analyze_correlation
# qos_rs999 -> test_qos_export_metrics
################################################################################

SET (qos_analyze_route, qos_rs999, test_qos_analyze_correlation) INTO ROUTE;200
EXPORT FROM ROUTE WHERE name == "qos_analyze_route";200;/action/routes/qos_analyze_route

SET (qos_export_route, qos_rs999, test_qos_export_metrics) INTO ROUTE;200
EXPORT FROM ROUTE WHERE name == "qos_export_route";200;/action/routes/qos_export_route

################################################################################
# Posts satisfied metrics
################################################################################

SET (qos_m10, 10, CURRENT_TIMESTAMP) INTO METRICS;200
SET (qos_m20, 20, CURRENT_TIMESTAMP) INTO METRICS;200
SET (qos_m30, 30, CURRENT_TIMESTAMP) INTO METRICS;200

SET (qos_m0_p999, 10, CURRENT_TIMESTAMP) INTO METRICS;200

################################################################################
# Executes the destination actions directly
################################################################################

# EXECUTE test_qos_analyze_correlation (qos_m0_p999) VALUES (10);400
# EXECUTE test_qos_export_metrics (qos_m0_p999) VALUES (10);400

################################################################################
# Executes the destination actions to posts an unsatisfied metrics
################################################################################

#SET (qos_m0_p999, 200, CURRENT_TIMESTAMP) INTO METRICS;200
